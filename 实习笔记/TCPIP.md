# TCP-IP 详解

## 第一章 概述

### 1.2分层

> 网络协议通常分不同层次进行开发，每一层分别 负责不同的通信功能。一个协议族，比如 T C P / I P，是 一组不同层次上的多个协议的组合。 T C P / I P通常被认 为是一个四层协议系统.

![](D:\实习笔记\pic\Snipaste_2018-07-03_17-31-04.png)

* **链路层**， 有时也称作数据链路层或网络接口层， 通常包括操作系统中的设备驱动程序和计算机 中对应的网络接口卡。    
* **网络层**，有时也称作互联网层，处理分组在网络中的活动，例如分组的选路。在 T C P / I P协议族中，网络层协议包括 I P协议（网际协议）， I C M P协议（I n t e r n e t互联网控 制报文协议），以及I G M P协议（I n t e r n e t组管理协议）。    
* **运输层**, 主要为两台主机上的应用程序提供端到端的通信。在 T C P / I P协议族中，有两个 互不相同的传输协议： T C P（传输控制协议）和 U D P（用户数据报协议）。    
  * T C P为两台主机提供高可靠性的数据通信。它所做的工作包括把应用程序交给它的数据分 成合适的小块交给下面的网络层，确认接收到的分组，设置发送最后确认分组的超时时钟 等。由于运输层提供了高可靠性的端到端的通信，因此应用层可以忽略所有这些细节。    
  * U D P则为应用层提供一种非常简单的服务。它只是把称作数据报的分组 从一台主机发送到另一台主机，但并不保证该数据报能到达另一端。任何必需的可靠 性必须由应用层来提供。    
* **应用层**,负责处理特定的应用程序细节。几乎各种不同的 T C P / I P实现都会提供下面这些 通用的应用程序：    
  * Telnet 远程登录。 
  *  FTP 文件传输协议。 
  *  SMTP 简单邮件传送协议。
  *  SNMP 简单网络管理协议。    

![Snipaste_2018-07-03_17-37-25](D:\实习笔记\pic\Snipaste_2018-07-03_17-37-25.png)

​	这里，我们列举了一个 F T P客户程序和另一个 F T P服务器程序。大多数的网络应用程序都 被设计成**客户—服务器**模式。服务器为客户提供某种服务，在本例中就是访问服务器所在主 机上的文件。在远程登录应用程序 Te l n e t中，为客户提供的服务是登录到服务器主机上。 

在图1 - 2中列举了四种不同层次上的协议。 F T P是一种应用层协议， T C P是一种运输层协 议， I P是一种网络层协议，而以太网协议则应用于链路层上。 **T C P / I P协议族是一组不同的协 议组合在一起构成的协议族。**尽管通常称该协议族为 T C P / I P**，但T C P和I P只是其中的两种协 议而已**（该协议族的另一个名字是 I n t e r n e t协议族(Internet Protocol Suite)）。      

### 1.6 封装 

当应用程序用 T C P传送数据时，数据被送入协议栈中，然后逐个通过每一层直到被当作 一串比特流送入网络。其中每一层对收到的数据都要增加一些首部信息（有时还要增加尾部 信息），该过程如图 1 - 7所示。 T C P传给I P的数据单元称作 T C P报文段或简称为 T C P段（T C P s e g m e n t）。 I P传给网络接口层的数据单元称作 I P数据报(IP datagram)。通过以太网传输的比特 流称作帧(Fr a m e ).

 ![](D:\实习笔记\pic\Snipaste_2018-07-03_18-08-44.png)

U D P数据与 T C P数据基本一致。唯一的不同是 U D P传给 I P的信息单元称作 U D P数据报 （UDP datagram），而且U D P的首部长为8字节。    

回想1 . 3节中的图1 - 4，由于TCP、UDP、 I C M P和I G M P都要向I P传送数据，因此 I P必须在 生成的 I P首部中加入某种标识，以表明数据属于哪一层。为此， I P在首部中存入一个长度为 8 b i t的数值，称作协议域。

 1表示为ICMP协议， 2表示为IGMP协议， 6表示为TCP协议，17表 示为UDP协议。 

类似地，许多应用程序都可以使用 T C P或U D P来传送数据。运输层协议在生成报文首部 时要存入一个应用程序的标识符。 T C P和U D P都用一个1 6 b i t的端口号来表示不同的应用程序。 T C P和U D P把源端口号和目的端口号分别存入报文首部中。    

### 1.7 分用

> 当目的主机收到一个以太网数据帧时，数据就开始从协议栈中由底向上升，同时去掉各 层协议加上的报文首部。每层协议盒都要去检查报文首部中的协议标识，以确定接收数据的 上层协议。这个过程称作分用.

![](D:\实习笔记\pic\Snipaste_2018-07-03_18-13-06.png)

### 1.8 客户-服务器模型    

> 大部分网络应用程序在编写时都假设一端是客户，另一端是服务器，其目的是为了让服 务器为客户提供一些特定的服务    

可以将这种服务分为两种类型：重复型或并发型。重复型服务器通过以下步骤进行交互：    

1. 等待一个客户请求的到来。

2. 处理客户请求。

3. 发送响应给发送请求的客户。

4. 返回1步。 

   重复型服务器主要的问题发生在 I 2状态。在这个时候，它不能为其他客户机提供服务.

​        相应地，并发型服务器采用以下步骤： 

1. 等待一个客户请求的到来。

2. 启动一个新的服务器来处理这个客户的请求。在这期间可能生成一个新的进程、任务 或线程，并依赖底层操作系统的支持。这个步骤如何进行取决于操作系统。生成的新服务器 对客户的全部请求进行处理。处理结束后，终止这个新服务器。

3. 返回 1步     

   

**对服务器，而不是对客户进行分类的原因是因为对于一个客户来说，它通常并不能够辨 别自己是与一个重复型服务器或并发型服务器进行对话。**    

**T C P服务器是并发的，而 U D P服务器是重复的.**

​	在一个互联网上，每个接口都用 I P地址来标识，尽管用户习惯使用主机名而不是 I P地址。 **域名系统**为主机名和 I P地址之间提供动态的映射。**端口号**用来标识互相通信的应用程序。**服 务器使用知名端口号，而客户使用临时设定的端口号**。    

## 第二章 链路层

### 2.8 最大传输单元MTU    

以太网和 8 0 2 . 3对数据帧的长度都有一个限制，其最大值分别是 1 5 0 0和1 4 9 2字节。链路层的这个特性称作 M T U，最大传输单元。不同类型的网络大 多数都有一个上限。 如果 I P层有一个数据报要传，而且数 据的长度比链路层的 M T U还大，那么 I P层 就需要进行**分片**（f r a g m e n t a t i o n），把数据 报分成若干片，这样每一片都小于 M T U。    

## TCP

### 传输控制协议    

* 在一个T C P连接中，仅有两方进行彼此通信。在第 1 2章介绍的广播和多播不能用于 T C P    。
* 应用数据被分割成 T C P认为最适合发送的数据块。这和 U D P完全不同，应用程序产生的 数据报长度将保持不变。由 T C P传递给I P的信息单位称为报文段或段（s e g m e n t）（参见 图1 - 7）。在1 8 . 4节我们将看到T C P如何确定报文段的长度。    

一个 I P地址和一个端口号也称为一个插口（s o c k e t）。    插口对（s o c k e t p a i r） (包含客户I P地址、客户端口号、服务器 I P地址和服务器端口号的四元组 )可唯一确定互 联网络中每个T C P连接的双方。    